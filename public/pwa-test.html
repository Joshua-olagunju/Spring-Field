<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA Verification Test</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #3b82f6;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
      }
      .check-item {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #ccc;
      }
      .check-item.pass {
        background: #d1fae5;
        border-color: #10b981;
      }
      .check-item.fail {
        background: #fee2e2;
        border-color: #ef4444;
      }
      .check-item.warning {
        background: #fef3c7;
        border-color: #f59e0b;
      }
      .status {
        font-weight: bold;
        margin-right: 10px;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px 10px 0;
      }
      button:hover {
        background: #2563eb;
      }
      .info-box {
        background: #eff6ff;
        border: 1px solid #3b82f6;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .code {
        background: #1f2937;
        color: #10b981;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
      }
      #results {
        margin-top: 30px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç PWA Verification Tool</h1>
      <p class="subtitle">
        This page tests if your SpringField Estate PWA is properly configured
      </p>

      <button onclick="runTests()">‚ñ∂ Run All Tests</button>
      <button onclick="testInstall()">üì± Test Install Prompt</button>
      <button onclick="location.reload()">üîÑ Refresh</button>

      <div id="results"></div>

      <div class="info-box" style="margin-top: 30px">
        <h3 style="margin-top: 0">üí° Quick Tips:</h3>
        <ul>
          <li>
            Make sure you're running the dev server:
            <span class="code">npm run dev</span>
          </li>
          <li>PWA features work best in Chrome or Edge browser</li>
          <li>
            If app is already installed, uninstall it first to see install
            prompts
          </li>
          <li>Check browser console (F12) for detailed errors</li>
        </ul>
      </div>
    </div>

    <script>
      let deferredPrompt = null;

      // Listen for beforeinstallprompt
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log("‚úÖ beforeinstallprompt event fired - app is installable!");
      });

      async function runTests() {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "<h2>Test Results:</h2>";

        const tests = [];

        // Test 1: Check if running on localhost or HTTPS
        const isSecure =
          location.protocol === "https:" ||
          location.hostname === "localhost" ||
          location.hostname === "127.0.0.1";
        tests.push({
          name: "Secure Context (HTTPS or localhost)",
          pass: isSecure,
          message: isSecure
            ? "Running on secure context ‚úì"
            : "PWA requires HTTPS or localhost",
          type: isSecure ? "pass" : "fail",
        });

        // Test 2: Check for manifest
        const manifestLink = document.querySelector('link[rel="manifest"]');
        tests.push({
          name: "Manifest Link",
          pass: !!manifestLink,
          message: manifestLink
            ? `Found: ${manifestLink.href}`
            : "Manifest link not found in HTML",
          type: manifestLink ? "pass" : "fail",
        });

        // Test 3: Fetch and validate manifest
        let manifestValid = false;
        if (manifestLink) {
          try {
            const response = await fetch(manifestLink.href);
            const manifest = await response.json();
            manifestValid = !!(
              manifest.name &&
              manifest.icons &&
              manifest.icons.length > 0
            );
            tests.push({
              name: "Manifest Content",
              pass: manifestValid,
              message: manifestValid
                ? `Valid manifest with ${manifest.icons.length} icons`
                : "Manifest missing required fields",
              type: manifestValid ? "pass" : "fail",
            });
          } catch (err) {
            tests.push({
              name: "Manifest Content",
              pass: false,
              message: `Error loading manifest: ${err.message}`,
              type: "fail",
            });
          }
        }

        // Test 4: Check for service worker
        const swSupported = "serviceWorker" in navigator;
        tests.push({
          name: "Service Worker Support",
          pass: swSupported,
          message: swSupported
            ? "Browser supports service workers"
            : "Browser does not support service workers",
          type: swSupported ? "pass" : "fail",
        });

        // Test 5: Check if service worker is registered
        if (swSupported) {
          const registration = await navigator.serviceWorker.getRegistration();
          tests.push({
            name: "Service Worker Registration",
            pass: !!registration,
            message: registration
              ? `Service worker registered (${
                  registration.active ? "active" : "installing"
                })`
              : "No service worker registered yet",
            type: registration ? "pass" : "warning",
          });
        }

        // Test 6: Check if app is already installed
        const isStandalone =
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone;
        tests.push({
          name: "Installation Status",
          pass: true,
          message: isStandalone
            ? "‚úÖ App is installed and running in standalone mode"
            : "‚è≥ App is not installed (this is normal for testing)",
          type: isStandalone ? "pass" : "warning",
        });

        // Test 7: Check for beforeinstallprompt
        tests.push({
          name: "Install Prompt Available",
          pass: !!deferredPrompt,
          message: deferredPrompt
            ? '‚úÖ Install prompt is ready (click "Test Install Prompt" button)'
            : isStandalone
            ? "App already installed"
            : "Install prompt not available yet (try refreshing)",
          type: deferredPrompt ? "pass" : isStandalone ? "warning" : "warning",
        });

        // Display results
        tests.forEach((test) => {
          const div = document.createElement("div");
          div.className = `check-item ${test.type}`;
          div.innerHTML = `
                    <span class="status">${
                      test.pass ? "‚úÖ" : test.type === "warning" ? "‚ö†Ô∏è" : "‚ùå"
                    }</span>
                    <strong>${test.name}:</strong> ${test.message}
                `;
          resultsDiv.appendChild(div);
        });

        // Summary
        const passCount = tests.filter((t) => t.pass).length;
        const totalTests = tests.length;
        const summaryDiv = document.createElement("div");
        summaryDiv.className = "info-box";
        summaryDiv.innerHTML = `
                <h3>Summary: ${passCount}/${totalTests} tests passed</h3>
                ${
                  passCount === totalTests
                    ? '<p style="color: #10b981; font-weight: bold;">üéâ All tests passed! Your PWA is properly configured.</p>'
                    : '<p style="color: #f59e0b; font-weight: bold;">‚ö†Ô∏è Some tests failed. Check the details above and browser console.</p>'
                }
            `;
        resultsDiv.appendChild(summaryDiv);
      }

      async function testInstall() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          alert(
            `Install prompt ${
              outcome === "accepted" ? "accepted ‚úÖ" : "dismissed ‚ùå"
            }`
          );
          deferredPrompt = null;
        } else {
          alert(
            "‚ö†Ô∏è Install prompt not available.\n\nPossible reasons:\n1. App is already installed\n2. Browser hasn't fired the prompt yet (try refreshing)\n3. Browser doesn't support PWA installation"
          );
        }
      }

      // Auto-run tests on page load
      window.addEventListener("load", () => {
        setTimeout(runTests, 500);
      });
    </script>
  </body>
</html>
