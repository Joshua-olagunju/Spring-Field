<!DOCTYPE html>
<html>
<head>
    <title>Payment Debug Test - Port 5173</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Payment Debug Test (Frontend: 5173, Backend: 8000)</h1>
        
        <div style="margin: 20px 0;">
            <button onclick="testRealTimeAuth()">üîê Test Real-Time Auth</button>
            <button onclick="testFullPaymentFlow()">üí≥ Test Full Payment Flow</button>
            <button onclick="window.location.href='http://localhost:5173'">üè† Go to Main App</button>
            <button onclick="clearOutput()">üóëÔ∏è Clear Output</button>
        </div>
        
        <div id="output"></div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }
        
        async function testRealTimeAuth() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üîê Testing Real-Time Authentication...</h2>';
            
            // Get current auth data
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            const tokenBackup = localStorage.getItem('token');
            
            output.innerHTML += `<h3>Auth Data Check:</h3>`;
            output.innerHTML += `<p>Auth Token (authToken): ${authToken ? `<span class="success">Present (${authToken.substring(0, 30)}...)</span>` : '<span class="error">Missing</span>'}</p>`;
            output.innerHTML += `<p>Auth Token (token): ${tokenBackup ? `<span class="success">Present (${tokenBackup.substring(0, 30)}...)</span>` : '<span class="error">Missing</span>'}</p>`;
            output.innerHTML += `<p>User Data: ${userData ? '<span class="success">Present</span>' : '<span class="error">Missing</span>'}</p>`;
            
            if (userData) {
                const user = JSON.parse(userData);
                output.innerHTML += `<p>User ID: <strong>${user.id}</strong></p>`;
                output.innerHTML += `<p>User Email: <strong>${user.email}</strong></p>`;
                output.innerHTML += `<p>User Role: <strong>${user.role}</strong></p>`;
            }
            
            const tokenToUse = authToken || tokenBackup;
            
            if (!tokenToUse) {
                output.innerHTML += '<p class="error"><strong>‚ùå No auth token found! Please login first.</strong></p>';
                return;
            }
            
            try {
                // Test current auth status
                output.innerHTML += '<h3>Step 1: üîç Test Current Auth</h3>';
                const authResponse = await fetch(`${API_BASE_URL}/api/user`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenToUse}`,
                        'Accept': 'application/json'
                    }
                });
                
                const authResult = await authResponse.json();
                output.innerHTML += `<p>Auth Status: <strong>${authResponse.status}</strong></p>`;
                output.innerHTML += `<p>Auth Response: <pre>${JSON.stringify(authResult, null, 2)}</pre></p>`;
                
                if (authResponse.ok && authResult.success) {
                    output.innerHTML += '<p class="success"><strong>‚úÖ Authentication is working!</strong></p>';
                    
                    // Test a dummy payment verification
                    output.innerHTML += '<h3>Step 2: üß™ Test Dummy Payment Verification</h3>';
                    const dummyTxRef = 'SF_TEST_' + Date.now();
                    
                    const verifyResponse = await fetch(`${API_BASE_URL}/api/payments/verify/${dummyTxRef}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tokenToUse}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    const verifyResult = await verifyResponse.json();
                    output.innerHTML += `<p>Verify Status: <strong>${verifyResponse.status}</strong></p>`;
                    output.innerHTML += `<p>Verify Response: <pre>${JSON.stringify(verifyResult, null, 2)}</pre></p>`;
                    
                    if (verifyResponse.status === 401) {
                        output.innerHTML += '<p class="error"><strong>‚ùå Auth token expired or invalid!</strong></p>';
                    } else if (verifyResponse.status === 404) {
                        output.innerHTML += '<p class="warning"><strong>‚ö†Ô∏è Payment not found (expected for dummy tx_ref)</strong></p>';
                        output.innerHTML += '<p class="success"><strong>‚úÖ Auth token is working for API calls!</strong></p>';
                    } else {
                        output.innerHTML += '<p class="success"><strong>‚úÖ Auth token is working!</strong></p>';
                    }
                } else {
                    output.innerHTML += '<p class="error"><strong>‚ùå Authentication failed!</strong></p>';
                }
                
            } catch (error) {
                output.innerHTML += `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function testFullPaymentFlow() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üí≥ Testing Full Payment Flow...</h2>';
            
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
            
            if (!authToken) {
                output.innerHTML += '<p class="error"><strong>‚ùå No auth token found! Please login first.</strong></p>';
                return;
            }
            
            try {
                // Step 1: Initialize Payment
                output.innerHTML += '<h3>Step 1: üöÄ Initialize Payment</h3>';
                const initResponse = await fetch(`${API_BASE_URL}/api/payments/initialize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        package_type: 'landlord_with_tenants',
                        period: 'monthly',
                        amount: 7000,
                        plan_id: '227503'
                    })
                });
                
                const initResult = await initResponse.json();
                output.innerHTML += `<p>Init Status: <strong>${initResponse.status}</strong></p>`;
                output.innerHTML += `<p>Init Response: <pre>${JSON.stringify(initResult, null, 2)}</pre></p>`;
                
                if (initResponse.ok && initResult.success) {
                    const txRef = initResult.data.tx_ref;
                    output.innerHTML += '<p class="success"><strong>‚úÖ Payment initialization successful!</strong></p>';
                    
                    // Step 2: Verify Payment (simulate successful payment)
                    output.innerHTML += '<h3>Step 2: ‚úÖ Verify Payment</h3>';
                    const verifyResponse = await fetch(`${API_BASE_URL}/api/payments/verify/${txRef}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    const verifyResult = await verifyResponse.json();
                    output.innerHTML += `<p>Verify Status: <strong>${verifyResponse.status}</strong></p>`;
                    output.innerHTML += `<p>Verify Response: <pre>${JSON.stringify(verifyResult, null, 2)}</pre></p>`;
                    
                    if (verifyResponse.ok && verifyResult.success) {
                        output.innerHTML += '<p class="success"><strong>üéâ PAYMENT FLOW WORKING PERFECTLY!</strong></p>';
                        output.innerHTML += `<p class="success">Payment Status: <strong>${verifyResult.data.payment.status}</strong></p>`;
                        output.innerHTML += `<p class="success">Subscription Created: <strong>ID ${verifyResult.data.subscription.id}</strong></p>`;
                        output.innerHTML += `<p class="success">User Payment Count: <strong>${verifyResult.data.user_payment_count}</strong></p>`;
                    } else {
                        output.innerHTML += '<p class="error"><strong>‚ùå Payment verification failed!</strong></p>';
                    }
                } else {
                    output.innerHTML += '<p class="error"><strong>‚ùå Payment initialization failed!</strong></p>';
                }
                
            } catch (error) {
                output.innerHTML += `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        // Auto-run auth test on page load
        window.onload = () => {
            setTimeout(testRealTimeAuth, 500);
        };
    </script>
</body>
</html>