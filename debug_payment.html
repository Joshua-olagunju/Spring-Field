<!DOCTYPE html>
<html>
<head>
    <title>Payment Debug Test - Port 5173</title>
</head>
<body>
    <h1>Payment API Debug Test (Frontend: 5173, Backend: 8000)</h1>
    <button onclick="testRealTimeAuth()">Test Real-Time Auth</button>
    <button onclick="window.location.href='http://localhost:5173'">Go to Main App</button>
    <div id="output"></div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        async function testRealTimeAuth() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>Testing Real-Time Authentication...</h2>';
            
            // Get current auth data
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            const tokenBackup = localStorage.getItem('token');
            
            output.innerHTML += `<h3>Auth Data Check:</h3>`;
            output.innerHTML += `<p>Auth Token (authToken): ${authToken ? `Present (${authToken.substring(0, 30)}...)` : 'Missing'}</p>`;
            output.innerHTML += `<p>Auth Token (token): ${tokenBackup ? `Present (${tokenBackup.substring(0, 30)}...)` : 'Missing'}</p>`;
            output.innerHTML += `<p>User Data: ${userData ? 'Present' : 'Missing'}</p>`;
            
            if (userData) {
                const user = JSON.parse(userData);
                output.innerHTML += `<p>User ID: ${user.id}</p>`;
                output.innerHTML += `<p>User Email: ${user.email}</p>`;
                output.innerHTML += `<p>User Role: ${user.role}</p>`;
            }
            
            const tokenToUse = authToken || tokenBackup;
            
            if (!tokenToUse) {
                output.innerHTML += '<p style="color: red;"><strong>❌ No auth token found!</strong></p>';
                return;
            }
            
            try {
                // Test current auth status
                output.innerHTML += '<h3>Step 1: Test Current Auth</h3>';
                const authResponse = await fetch(`${API_BASE_URL}/api/user`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenToUse}`,
                        'Accept': 'application/json'
                    }
                });
                
                const authResult = await authResponse.json();
                output.innerHTML += `<p>Auth Status: ${authResponse.status}</p>`;
                output.innerHTML += `<p>Auth Response: <pre>${JSON.stringify(authResult, null, 2)}</pre></p>`;
                
                if (authResponse.ok && authResult.success) {
                    // Test a dummy payment verification
                    output.innerHTML += '<h3>Step 2: Test Dummy Payment Verification</h3>';
                    const dummyTxRef = 'SF_TEST_' + Date.now();
                    
                    const verifyResponse = await fetch(`${API_BASE_URL}/api/payments/verify/${dummyTxRef}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tokenToUse}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    const verifyResult = await verifyResponse.json();
                    output.innerHTML += `<p>Verify Status: ${verifyResponse.status}</p>`;
                    output.innerHTML += `<p>Verify Response: <pre>${JSON.stringify(verifyResult, null, 2)}</pre></p>`;
                    
                    if (verifyResponse.status === 401) {
                        output.innerHTML += '<p style="color: red;"><strong>❌ Auth token expired or invalid!</strong></p>';
                    } else if (verifyResponse.status === 404) {
                        output.innerHTML += '<p style="color: orange;"><strong>⚠️ Payment not found (expected for dummy tx_ref)</strong></p>';
                    } else {
                        output.innerHTML += '<p style="color: green;"><strong>✅ Auth token is working!</strong></p>';
                    }
                } else {
                    output.innerHTML += '<p style="color: red;"><strong>❌ Authentication failed!</strong></p>';
                }
                
            } catch (error) {
                output.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        async function testAuth() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>Testing Authentication...</h2>';
            
            // Get token from localStorage (like the app does)
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            
            output.innerHTML += `<p>Auth Token: ${authToken ? 'Present' : 'Missing'}</p>`;
            output.innerHTML += `<p>User Data: ${userData ? 'Present' : 'Missing'}</p>`;
            
            if (userData) {
                const user = JSON.parse(userData);
                output.innerHTML += `<p>User ID: ${user.id}</p>`;
                output.innerHTML += `<p>User Email: ${user.email}</p>`;
                output.innerHTML += `<p>User Role: ${user.role}</p>`;
            }
            
            if (!authToken) {
                output.innerHTML += '<p style="color: red;">No auth token found. Please login first.</p>';
                return;
            }
            
            try {
                // Test 1: Check authentication
                output.innerHTML += '<h3>Test 1: Check Authentication</h3>';
                const authResponse = await fetch(`${API_BASE_URL}/api/user`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const authResult = await authResponse.json();
                output.innerHTML += `<p>Auth Response Status: ${authResponse.status}</p>`;
                output.innerHTML += `<p>Auth Response: <pre>${JSON.stringify(authResult, null, 2)}</pre></p>`;
                
                if (authResponse.ok) {
                    // Test 2: Initialize Payment
                    output.innerHTML += '<h3>Test 2: Initialize Payment</h3>';
                    const initResponse = await fetch(`${API_BASE_URL}/api/payments/initialize`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            package_type: 'landlord_with_tenants',
                            period: 'monthly',
                            amount: 7000,
                            plan_id: '227503'
                        })
                    });
                    
                    const initResult = await initResponse.json();
                    output.innerHTML += `<p>Init Response Status: ${initResponse.status}</p>`;
                    output.innerHTML += `<p>Init Response: <pre>${JSON.stringify(initResult, null, 2)}</pre></p>`;
                    
                    if (initResponse.ok && initResult.success) {
                        const txRef = initResult.data.tx_ref;
                        
                        // Test 3: Verify Payment
                        output.innerHTML += '<h3>Test 3: Verify Payment</h3>';
                        const verifyResponse = await fetch(`${API_BASE_URL}/api/payments/verify/${txRef}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        const verifyResult = await verifyResponse.json();
                        output.innerHTML += `<p>Verify Response Status: ${verifyResponse.status}</p>`;
                        output.innerHTML += `<p>Verify Response: <pre>${JSON.stringify(verifyResult, null, 2)}</pre></p>`;
                        
                        if (verifyResult.success) {
                            output.innerHTML += '<p style="color: green;"><strong>✅ All API calls successful!</strong></p>';
                        } else {
                            output.innerHTML += '<p style="color: red;"><strong>❌ Payment verification failed</strong></p>';
                        }
                    } else {
                        output.innerHTML += '<p style="color: red;"><strong>❌ Payment initialization failed</strong></p>';
                    }
                } else {
                    output.innerHTML += '<p style="color: red;"><strong>❌ Authentication failed</strong></p>';
                }
                
            } catch (error) {
                output.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        // Run test when page loads
        window.onload = testAuth;
    </script>
</body>
</html>